############################
#
# Endtimes Crisis Events
#
# Written by BowlerHatGuy
#
############################

# Naming Scheme
# PSNN = [PRIMARY][SUBTYPE][NUMBER][NUMBER] 
# Subtypes:
# 0 = hidden
# 1 = basic text box
# 2 = catch event (default states and when players think thye are clever)
# 3 = diplomatic
# 4-9 = utility
# Note: Number 00 is unused

namespace = endtimescrisis

### THE FAULT IN THE STARS

### Triggering Event
# Notice: Meta-crisis may have side effects including depression, mass suicide, and universal destruction. Use only as advised.
country_event = {
	id = endtimescrisis.404
	hide_window = yes
	
	trigger = { always = no }
	
	immediate = {
		endgame_telemetry = vultaum
		country_event = { id = endtimescrisis.4001 days = 10 }
	}
}

### PRELUDE
# Initializes the chain and distributes events to all empires (HIDDEN)
country_event = {
	id = endtimescrisis.4001
	hide_window = yes
	fire_only_once = yes
	
	is_triggered_only = yes
	
	immediate = {
		endgame_telemetry = vultaum
		set_global_flag = endtimes_vultaum_shifting_stars
		set_global_flag = endtimes_vultaum_crisis_happened
		set_global_flag = galactic_crisis_happened
		every_country = {
			limit = { is_country_type = default }
			country_event = { id = endtimescrisis.4101 }
		}
		
		set_timed_global_flag = { flag = endtimes_crisis_timeout days = 60 }
	}
}

# Alerts an empire about the strange patterns in the stars
country_event = {
	id = endtimescrisis.4101
	title = "endtimescrisis.4101.name"
	desc = "endtimescrisis.4101.desc"
	picture = GFX_evt_physics_research
	show_sound = event_alien_signal
	
	is_triggered_only = yes
	
	option = {
		trigger = {
			has_global_flag = endtimes_faulty_stars
		}
		name = endtimescrisis.4101.a
		begin_event_chain = {
			event_chain = "fault_in_the_stars_chain"
			target = ROOT
		}
	}
	option = {
		trigger = {
			AND = {
				has_country_flag = star_crazy
				NOT = { has_global_flag = endtimes_faulty_stars }
			}
		}
		name = endtimescrisis.4101.b
		begin_event_chain = {
			event_chain = "fault_in_the_stars_chain"
			target = ROOT
		}
	}
	option = {
		trigger = {
			NOR = {
				has_country_flag = star_crazy
				has_global_flag = endtimes_faulty_stars
			}
		}
		name = endtimescrisis.4101.c
		begin_event_chain = {
			event_chain = "fault_in_the_stars_chain"
		}
	}
}

### NEUTRON STAR
# Initializes the Vultaum home system if has not already been discovered (HIDDEN)
country_event = {
	id = endtimescrisis.4002
	hide_window = yes
	fire_only_once = yes
	
	mean_time_to_happen = {
		months = 600
	}
	
	trigger = {
		is_country_type = default
		has_global_flag = endtimes_vultaum_shifting_stars
		
		NOT = { has_global_flag = endtimes_crisis_timeout }
	}
	
	immediate = {
		remove_global_flag = endtimes_vultaum_shifting_stars
		set_global_flag = endtimes_vultaum_neutron_star
		set_global_flag = endtimes_faulty_stars
		
		if = {
			# Catch for if the game does not have Vultaum precursors
			limit = { 
				NOT = { any_country = { has_country_flag = vultaum_intro } }
			}
			
			# Spawns a low-value version of the Vultaum home system with Neutron Star already in place
			random_system = {
				spawn_system = {
					min_distance = 20
					max_distance = 80
					initializer = "endtimes_dep_vultaumar_system"
				}
			}
		}
		else_if = {
			# Checks if there are Vultaum precursors and whether the homeworld is discovered
			limit = {
				any_country = { has_country_flag = vultaum_intro }
				NOT = {
					any_system = { has_star_flag = vultaumar }
				}
			}
			
			# Generates Vultaum Home System
			random_system = {
				limit = { has_star_flag = precursor_1 }
				spawn_system = {
					min_distance = 20
					max_distance = 50
					initializer = "vultaumar_system"
				}
			}
			
			# Converts star to Neutron Star
			random_system = {
				limit = { has_star_flag = vultaumar }
				random_system_planet = {
					limit = { is_star = yes }
					change_pc = pc_pulsar
				}
				save_global_event_target_as = endtimes_neutron_star_evt
			}
			
			# Ends the precursor chain and alerts everyone to the home system AFTER the neutron signal is observed
			set_global_flag = vultaum_system_discovered
			every_country = {
				limit = { is_country_type = default }
				add_event_chain_counter = {
					event_chain = "vultaum_chain"
					counter = "vultaum_artifacts"
					amount = 6
				}
				country_event = { id = precursor.97 days = 5 }
			}
		}
		else = {
			# Converts star to Neutron Star
			random_system = {
				limit = { has_star_flag = vultaumar }
				random_system_planet = {
					limit = { is_star = yes }
					change_pc = pc_pulsar
				}
				save_global_event_target_as = endtimes_neutron_star_evt
			}
		}
		
		# Creates POI
		random_system = {
			limit = { has_star_flag = vultaumar } #FIXME
		}
		
		every_country = {
			limit = { is_country_type = default }
			country_event = { id = endtimescrisis.4102 }
		}
		
		set_timed_global_flag = { flag = endtimes_crisis_timeout days = 60 }
	}
}

# Alerts empires to the neutron star
country_event = {
	id = endtimescrisis.4102
	title = "endtimescrisis.4102.name"
	picture = GFX_evt_star_pulsar
	location = event_target:endtimes_neutron_star_evt
	
	is_triggered_only = yes
	
	# Decription if there was no Vultaum precursor in the galaxy
	desc = {
		trigger = {
			NOT = {
				any_country = { has_country_flag = vultaum_intro }
			}
		}
		text = "endtimescrisis.4102.novultaum"
	}
	
	# Description if Vultaum HW was not yet discovered
	desc = {
		trigger = {
			AND = {
				NOT = { has_country_flag = vultaum_system }
				any_country = { has_country_flag = vultaum_intro }
			}
		}
		text = "endtimescrisis.4102.nohomeworld"
	}
	
	# Description if Vultaum HW already known
	desc = {
		trigger = {
			has_country_flag = vultaum_system
		}
		text = "endtimescrisis.4102.main"
	}
	
	option = {
		name = endtimescrisis.4102.a
		hidden_effect = {
			end_event_chain = "fault_in_the_stars_chain"
			begin_event_chain = {
				event_chain = "neutron_star_chain"
				target = ROOT
			}
		
			create_point_of_interest = {
				id = endtimes_neutronstar.1
				name = "endtimes_neutron_star_poi"
				desc = "endtimes_neutron_star_poi_desc"
				event_chain = neutron_star_chain
				location = event_target:endtimes_neutron_star_evt
			}
		}
	}
}


## THE OUTSIDERS
# Distributes messages to all of the empires (HIDDEN)
country_event = {
	id = endtimescrisis.4003
	hide_window = yes
	fire_only_once = yes
	
	mean_time_to_happen = {
		months = 120
	}
	
	trigger = {
		is_country_type = default
		has_global_flag = endtimes_vultaum_neutron_star
		
		NOT = { has_global_flag = endtimes_crisis_timeout }
	}
	
	immediate = {
		remove_global_flag = endtimes_vultaum_neutron_star
		set_global_flag = endtimes_outsiders_signal
		every_country = {
			limit = {is_country_type = default }
			country_event = { id = endtimescrisis.4103 }
		}
		every_country = { # Forces non-machine fallen empires to awaken
			limit = { 
				is_country_type = fallen_empire 
				NOT = { has_authority = auth_machine_intelligence }
			}
			country_event = { id = endtimesutility.0001 days = 30 }
		}
		
		set_timed_global_flag = { flag = endtimes_crisis_timeout days = 120 }
	}
}

# Message to alert empires that the Neutron Star is talking to them
country_event = {
	id = endtimescrisis.4103
	title = "endtimescrisis.4103.name"
	desc = "endtimescrisis.4103.desc"
	picture = GFX_evt_wormhole
	show_sound = event_radio_chatter
	
	is_triggered_only = yes
	
	
	option = {
		name = endtimescrisis.4103.a
		hidden_effect = {
			country_event = { id = endtimescrisis.4303 }
			country_event = { id = endtimesradiant.4100 days = 10 }
		}
	}
}

# First Diplomatic Event to Contact the Outsiders
country_event = {
	id = endtimescrisis.4303
	title = "TRANSMISSION"
	
	is_triggered_only = yes
	
	desc = {
		text = endtimescrisis.4303.desc
	}
	
	diplomatic = yes
	
	picture_event_data = {
		room = no_video_feed_room
	}
	
	option = {
		name = endtimescrisis.4303.WHOAREYOU
		response_text = endtimescrisis.4303.WEARE
		is_dialog_only = yes
	}
	option = {
		name = endtimescrisis.4303.WHATDOYOUWANT
		response_text = endtimescrisis.4303.WEWANT
		hidden_effect = {
			set_country_flag = endtimes_what_they_want
		}
		is_dialog_only = yes
	}
	option = {
		allow = {
			has_country_flag = endtimes_what_they_want
		}
		name = endtimescrisis.4303.HOW
		response_text = endtimescrisis.4303.TOOSOON
		is_dialog_only = yes
	}
	option = {
		allow = {
			has_country_flag = endtimes_what_they_want
		}
		name = endtimescrisis.4303.WHY
		response_text = endtimescrisis.4303.HERESWHY
		is_dialog_only = yes
	}
	option = {
		trigger = {
			has_authority = auth_machine_intelligence
		}
		allow = {
			has_country_flag = endtimes_what_they_want	
		}
		name = endtimescrisis.4303.ISTHEREROOM
		response_text = endtimescrisis.4303.ROOMFORALL
		is_dialog_only = yes
	}
	option = { # HERESY
		trigger = {
			OR = {
				has_ethic = ethic_spiritualist
				has_ethic = ethic_fanatic_spiritualist
			}
		}
		allow = {
			has_country_flag = endtimes_what_they_want
		}
		
		name = endtimescrisis.4303.GOODBYE.SPIR
		response_text = endtimescrisis.4303.FAREWELL
		remove_country_flag = endtimes_what_they_want
	}
	option = {
		allow = {
			has_country_flag = endtimes_what_they_want
			NOR = {
				has_ethic = ethic_spiritualist
				has_ethic = ethic_fanatic_spiritualist
			}
		}
		name = endtimescrisis.4303.GOODBYE
		response_text = endtimescrisis.4303.FAREWELL
		remove_country_flag = endtimes_what_they_want
	}
}


## THE CHOICE
country_event = {
	id = endtimescrisis.4004
	hide_window = yes
	fire_only_once = yes
	
	mean_time_to_happen = {
		months = 24
	}
	
	trigger = {
		is_country_type = default
		has_global_flag = endtimes_outsiders_signal
		
		NOT = { has_global_flag = endtimes_crisis_timeout }
	}
	
	immediate = {
		remove_global_flag = endtimes_outsiders_signal
		set_global_flag = endtimes_outsiders_choice
		every_country = {
			limit = { is_country_type = default }
			country_event = { id = endtimescrisis.4104 }
		}
	
		every_country = {
			limit = { is_country_type = awakened_fallen_empire }
			country_event = { id = endtimescrisis.4204 days = 10 }
		}
		
		every_country = {
			limit = { is_country_type = global_event }
			country_event = { id = endtimesutility.0002 }
		}
		
		set_timed_global_flag = { flag = endtimes_crisis_timeout days = 30 }
	}
}

country_event = {
	id = endtimescrisis.4104
	title = "endtimescrisis.4104.name"
	desc = "endtimescrisis.4104.desc"
	picture = GFX_evt_wormhole
	show_sound = event_radio_chatter
	
	is_triggered_only = yes
	
	option = {
		trigger = {
			NOT = { has_country_flag = endtimes_no_choice }
		}
		
		name = endtimescrisis.4104.a
		country_event = { id = endtimescrisis.4304 }
	}
	option = {
		trigger = {
			has_country_flag = endtimes_no_choice
		}
		
		name = endtimescrisis.4104.RUDE
		country_event = { id = endtimescrisis.4304 }
	}
}

country_event = { # Refires the dialog if the player exits out before choosing a side, or triggers an autoflag if the player is being obstinent
	id = endtimescrisis.4204
	hide_window = yes
	
	trigger = {
		is_country_type = default
		has_global_flag = endtimes_outsiders_choice
		NOR = {
			has_country_flag = endtimes_resistance
			has_country_flag = endtimes_cooperator
		}
	}

	immediate = {
		if = { # TODO: Need event to indicate to other empires that a new empire has come into existance and they have made a choice.
			limit = { NOT = { has_country_flag = endtimes_no_choice } }
			set_country_flag = endtimes_no_choice
			
			country_event = { id = endtimescrisis.4104 }
		}
		else = {
			remove_country_flag = endtimes_no_choice
			set_country_flag = endtimes_resistance
			
			country_event = { id = endtimescrisis.4504 }
		}
	}
}

# The Outsiders levy a choice on the empires: help them or stand aside
country_event = {
	id = endtimescrisis.4304
	title = "TRANSMISSION"
	
	is_triggered_only = yes
	
	desc = {
		trigger = {
			NOT = { has_country_flag = endtimes_no_choice }
		}
		text = endtimescrisis.4304.desc
	}
	desc = {
		trigger = {
			has_country_flag = endtimes_no_choice
		}
		text = endtimescrisis.4304.desc.RUDE
	}
	
	diplomatic = yes
	
	picture_event_data = {
		room = no_video_feed_room
	}
	
	# Yes based on ethics
	option = {
		trigger = {
			OR = {
				has_ethic = ethic_spiritualist
				has_ethic = ethic_fanatic_spiritualist
			}
		}
		
		name = endtimescrisis.4304.YES.SPIR
		response_text = endtimescrisis.4304.WONDERFUL
		
		set_country_flag = endtimes_cooperator
		remove_country_flag = endtimes_no_choice
		
		hidden_effect = {
			end_event_chain = "neutron_star_chain"
			begin_event_chain = {
				event_chain = "crash_the_simulation_chain_coop"
				target = ROOT
			}
			create_point_of_interest = {
				id = endtimes_neutronstar.1
				name = "endtimes_neutron_star_poi"
				desc = "endtimes_neutron_star_poi_desc"
				event_chain = crash_the_simulation_chain_coop
				location = event_target:endtimes_neutron_star_evt
			}
		}
		
		ai_chance = {
			factor = 0
		}
	}
	
	# Universal YES
	option = {
		trigger = {
			NOR = {
				has_ethic = ethic_spiritualist
				has_ethic = ethic_fanatic_spiritualist
			}
		}
		name = endtimescrisis.4304.YES
		response_text = endtimescrisis.4304.WONDERFUL
		
		set_country_flag = endtimes_cooperator
		remove_country_flag = endtimes_no_choice
		
		hidden_effect = {
			end_event_chain = "neutron_star_chain"
			begin_event_chain = {
				event_chain = "crash_the_simulation_chain_coop"
				target = ROOT
			}
			create_point_of_interest = {
				id = endtimes_neutronstar.1
				name = "endtimes_neutron_star_poi"
				desc = "endtimes_neutron_star_poi_desc"
				event_chain = crash_the_simulation_chain_coop
				location = event_target:endtimes_neutron_star_evt
			}
		}
		
		ai_chance = {
			factor = 50
			modifier = {
				factor = 1.5
				OR = {
					has_ethic = ethic_materialist
					has_ethic = ethic_egalitarian
					has_ethic = ethic_fanatic_egalitarian
				}
			}
			modifier = {
				factor = 2
				OR = {
					has_ethic = ethic_fanatic_materialist
					has_civic = civic_machine_assimilator
				}
			}
			modifier = {
				factor = 5
				OR = {
					has_civic = civic_machine_terminator
					has_civic = civic_fanatic_purifiers
				}
			}
			modifier = {
				factor = 0
				OR = {
					has_ethic = ethic_spiritualist
					has_ethic = ethic_fanatic_spiritualist
					has_civic = civic_hive_devouring_swarm
					has_civic = civic_inwards_perfection
				}
			}
		}
	}
	
	# Universal NO
	option = {
		name = endtimescrisis.4304.NO
		response_text = endtimescrisis.4304.SADDENING
		
		set_country_flag = endtimes_resistance
		remove_country_flag = endtimes_no_choice
		
		hidden_effect = {
			end_event_chain = "neutron_star_chain"
			begin_event_chain = {
				event_chain = "crash_the_simulation_chain_resist"
				target = ROOT
			}
			
			create_point_of_interest = {
				id = endtimes_neutronstar.1
				name = "endtimes_neutron_star_poi"
				desc = "endtimes_neutron_star_poi_desc"
				event_chain = crash_the_simulation_chain_resist
				location = event_target:endtimes_neutron_star_evt
			}
		}
		
		ai_chance = {
			factor = 50
			modifier = {
				factor = 1.5
				OR = {
					has_authority = auth_machine_intelligence
					has_ethic = ethic_authoritarian
					has_ethic = ethic_xenophile
					has_ethic = ethic_fanatic_xenophile
				}
			}
			modifier = {
				factor = 2
				OR = {
					has_ethic = ethic_fanatic_authoritarian
				}
			}
			modifier = {
				factor = 0
				OR = {
					
				}
			}
		}
	}
}

# Forces Awakened FEs onto sides after main empires have chosen
country_event = {
	id = endtimescrisis.4404
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		if = {
			limit = { 
				OR = {
					has_ethic = ethic_fanatic_spiritualist
					has_ethic = ethic_fanatic_xenophile
				}
			}
			set_country_flag = endtimes_resistance
		}
		else = {
			set_country_flag = endtimes_cooperator
		}
	}
}

country_event = { # Vultaum let the empire know that they take their silence as a statement of intent to resist
	id = endtimescrisis.4504
	title = "endtimescrisis.4504.name"
	desc = "endtimescrisis.4504.desc"
	picture = GFX_evt_physics_research
	
	is_triggered_only = yes
	
	option = {
		name = endtimescrisis.4504.a
		
		hidden_effect = {
				end_event_chain = "neutron_star_chain"
				begin_event_chain = {
					event_chain = "crash_the_simulation_chain_resist"
					target = ROOT
				}
			
				create_point_of_interest = {
					id = endtimes_neutronstar.1
					name = "endtimes_neutron_star_poi"
					desc = "endtimes_neutron_star_poi_desc"
					event_chain = crash_the_simulation_chain_resist
					location = event_target:endtimes_neutron_star_evt
				}
			}
	}
}

### Cooperator Chain
## THE PLAN
# Initializing Event that contacts the empires to explain the plan
country_event = {
	id = endtimescrisis.4005
	hide_window = yes
	fire_only_once = yes
	
	mean_time_to_happen = {
		months = 12
	}
	
	trigger = {
		NOT = { has_country_flag = endtimes_crisis_timeout }
	}
	
	immediate = {
		set_global_flag = endtimes_outsiders_plan
		every_country = {
			limit = { 
				is_country_type = default 
				has_country_flag = endtimes_cooperator
			}
			country_event = { id = endtimescrisis.4105 }
			set_timed_country_flag = { flag = endtimes_event_holdoff days = 10 }
		}
	}
}

# Contact Event for Default Empires
country_event = {
	id = endtimescrisis.4105
	title = "endtimescrisis.4105.name"
	desc = "endtimescrisis.4105.desc"
	picture = GFX_evt_wormhole
	show_sound = event_radio_chatter
	
	is_triggered_only = yes
	
	option = {
		name = endtimescrisis.4105.a
		hidden_effect = { country_event = { id = endtimescrisis.4305 } }
	}
}

# Catch event so the player doesn't accidentally miss the plan
country_event = {
	id = endtimescrisis.4205
	hide_window = yes
	
	trigger = {
		has_global_flag = endtimes_outsiders_plan
		has_country_flag = endtimes_cooperator
		NOT = { has_country_flag = endtimes_how_to_crash }
		NOT = { has_country_flag = endtimes_event_holdoff }
	}
	
	immediate = { # Go straight into the diplo screen again to avoid annoyances. EVALUATE FOR CHANGE
		country_event = { id = endtimescrisis.4305 }
	}
}

country_event = {
	id = endtimescrisis.4305
	title = "TRANSMISSION"
	desc = endtimescrisis.4305.desc
	
	is_triggered_only = yes
	
	diplomatic = yes
	
	picture_event_data = {
		room = no_video_feed_room
	}
	
	option = {
		name = endtimescrisis.4305.HOW
		response_text = endtimescrisis.4305.HERESHOW
		
		hidden_effect = {
			set_country_flag = endtimes_how_to_crash
		}
		is_dialog_only = yes
	}
	option = {
		name = endtimescrisis.4305.VERYWELL
		response_text = endtimescrisis.4305.WERECOUNTINGONYOU
	
		allow = {
			has_country_flag = endtimes_how_to_crash
		}
		
		hidden_effect = {
			country_event = { id = endtimescrisis.4405 days = 1 }
		}
	}
}

# Informs player that they can now build Jupiter Brains on gas giants
country_event = {
	id = endtimescrisis.4405
	title = "endtimescrisis.4405.name"
	desc = "endtimescrisis.4405.desc"
	picture = GFX_evt_megastructure_construction
	
	is_triggered_only = yes
	
	option = {
		name = endtimescrisis.4405.a
		custom_tooltip = "endtimescrisis.4405.TT"
	}
}

## Events Related to the construction of Jupiter Brains
# Alerts all empires to the start of construction of a brain
country_event = {
	id = endtimescrisis.4006
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		if = { # Inelegant solution until I come up with something better. TODO: Come up with something better.
			limit = { NOT = { has_global_flag = endtimes_first_jupiter_brain_const } }
			country_event = { id = endtimescrisis.4206 days = 1 } 
		}
		
		every_country = {
			limit = { is_country_type = default }
			if = {
				limit = { 
					AND = {
						NOT = { has_global_flag = endtimes_first_jupiter_brain_const }
						has_country_flag = endtimes_resistance
					}
				}
				country_event = { id = endtimescrisis.4406 }
			}
			else = {
				country_event = { id = endtimescrisis.4106 }
			}
		}
		
	}
}

country_event = {
	id = endtimescrisis.4106
	title = "endtimescrisis.4106.name"
	picture = GFX_evt_megastructure_construction
	location = event_target:endtimes_recent_jupiter_brain
	is_triggered_only = yes
	
	desc = {
		trigger = { 
			NOT = { has_global_flag = endtimes_first_jupiter_brain_const }
			has_country_flag = endtimes_cooperator
		}
		text = endtimescrisis.4106.desc.COOPFIRST
	}
	desc = {
		trigger = { 
			has_global_flag = endtimes_first_jupiter_brain_const
			has_country_flag = endtimes_resistance
			NOT = { has_global_flag = endtimes_first_rift }
		}
		text = endtimescrisis.4106.desc.RESISTNORIFT
	}
	desc = {
		trigger = { 
			has_global_flag = endtimes_first_jupiter_brain_const
			has_country_flag = endtimes_resistance
			has_global_flag = endtimes_first_rift
		}
		text = endtimescrisis.4106.desc.RESIST
	}
	desc = {
		trigger = { 
			has_global_flag = endtimes_first_jupiter_brain_const
			has_country_flag = endtimes_cooperator
		}
		text = endtimescrisis.4106.desc.COOP
	}
	
	option = {
		trigger = {
			has_country_flag = endtimes_cooperator
		}
		name = endtimescrisis.4106.a
	}
	option = {
		trigger = {
			has_country_flag = endtimes_resistance
		}
		name = endtimescrisis.4106.b
	}
}

# Solution to setting the flag after the empires have already been alerted to the first brain
country_event = { # Can probably be merged with 4406
	id = endtimescrisis.4206
	hide_window = yes
	fire_only_once = yes
	
	is_triggered_only = yes
	
	immediate = {
		set_global_flag = endtimes_first_jupiter_brain_const
	}
}

# Because Titles cannot be variable... First Jupiter Brain for resistance
country_event = {
	id = endtimescrisis.4406
	title = "endtimescrisis.4406.name"
	desc = "endtimescrisis.4406.desc"
	picture = GFX_evt_megastructure_construction
	
	is_triggered_only = yes
	
	option = {
		name = endtimescrisis.4406.a
	}
}


# Alerts all empires to the completion of construction of a brain
country_event = {
	id = endtimescrisis.4007
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		if = {
			limit = { NOT = { has_global_flag = endtimes_first_jupiter_brain } }
			country_event = { id = endtimescrisis.4207 days = 1 } # Cannot be moved due to need for delayed flag
		}
		
		every_country = {
			limit = { is_country_type = default }
			if = {
				limit = { 
					AND = {
						NOT = { has_global_flag = endtimes_first_jupiter_brain }
						has_country_flag = endtimes_resistance
					}
				}
				country_event = { id = endtimescrisis.4407 }
			}
			else = {
				country_event = { id = endtimescrisis.4107 }
			}
		}
		
		every_country = { # Variables for tracking. Again, not ideal implemenation.
			limit = { is_country_type = global_event }
			country_event = { id = endtimesutility.0003 }
		}
	}
}

country_event = {
	id = endtimescrisis.4107
	title = endtimescrisis.4107.name
	picture = GFX_evt_gas_giant
	location = event_target:endtimes_recent_jupiter_brain
	is_triggered_only = yes
	
	desc = {
		trigger = { 
			NOT = { has_global_flag = endtimes_first_jupiter_brain }
			has_country_flag = endtimes_cooperator
		}
		text = endtimescrisis.4107.desc.COOPFIRST
	}
	desc = {
		trigger = { 
			has_global_flag = endtimes_first_jupiter_brain
			has_country_flag = endtimes_resistance
			NOT = { has_global_flag = endtimes_first_rift }
		}
		text = endtimescrisis.4107.desc.RESISTNORIFT
	}
	desc = {
		trigger = { 
			has_global_flag = endtimes_first_jupiter_brain
			has_country_flag = endtimes_resistance
			has_global_flag = endtimes_first_rift
		}
		text = endtimescrisis.4107.desc.RESIST
	}
	desc = {
		trigger = { 
			has_global_flag = endtimes_first_jupiter_brain
			has_country_flag = endtimes_cooperator
		}
		text = endtimescrisis.4107.desc.COOP
	}
	
	option = {
		trigger = {
			has_country_flag = endtimes_cooperator
		}
		name = endtimescrisis.4107.a
		
		hidden_effect = { 
			if = {
				limit = { has_event_chain = "crash_the_simulation_chain_coop" }
				endtimes_allocate_poi = yes
				add_event_chain_counter = {
					event_chain = "crash_the_simulation_chain_coop"
					counter = "endtimes_active_jupiter_brains"
					amount = 1
				}
			}
		}
	}
	option = {
		trigger = {
			has_country_flag = endtimes_resistance
		}
		name = endtimescrisis.4107.b
		
		hidden_effect = {
			if = {
				limit = { has_event_chain = "crash_the_simulation_chain_resist" }
				endtimes_allocate_poi = yes
				add_event_chain_counter = {
					event_chain = "crash_the_simulation_chain_resist"
					counter = "endtimes_active_jupiter_brains"
					amount = 1
				}
			}
		}
	}
}

# Solution to setting the flag after the empires have already been alerted to the first brain
country_event = { # Can probably be consolidated into 4407
	id = endtimescrisis.4207
	hide_window = yes
	fire_only_once = yes
	
	is_triggered_only = yes
	
	immediate = {
		set_global_flag = endtimes_first_jupiter_brain
	}
}

# Solution for inability to set Title text based on conditions
country_event = {
	id = endtimescrisis.4407
	title = "endtimescrisis.4407.name"
	desc = "endtimescrisis.4407.desc"
	picture = GFX_evt_gas_giant
	
	is_triggered_only = yes
	
	option = {
		name = endtimescrisis.4407.a
		hidden_effect = {
			if = {
				limit = { has_event_chain = "crash_the_simulation_chain_resist" }
				endtimes_allocate_poi = yes
				add_event_chain_counter = {
					event_chain = "crash_the_simulation_chain_resist"
					counter = "endtimes_active_jupiter_brains"
					amount = 1
				}
			}
		}
	}
}

## Instability (aka Crisis Severity) Events
# Instability I Initializer
country_event = {
	id = endtimescrisis.4008
	hide_window = yes
	fire_only_once = yes
	
	trigger = {
		has_global_flag = endtimes_outsiders_plan
		has_global_flag = endtimes_allow_instability
		NOR = {
			has_global_flag = endtimes_instability_I
			has_global_flag = endtimes_instability_II
			has_global_flag = endtimes_instability_III
			has_global_flag = endtimes_the_escape
		}
	}
	
	immediate  ={
		set_global_flag = endtimes_instability_I
		remove_global_flag = endtimes_allow_instability
		
		every_country = {
			limit = { is_country_type = default }
			country_event = { id = endtimescrisis.4108 }
		}
	}
}

# Something is wrong...
country_event = {
	id = endtimescrisis.4108
	title = "endtimescrisis.4108.name"
	desc = "endtimescrisis.4108.desc"
	picture = "GFX_evt_surreal_visions"
	
	is_triggered_only = yes
	
	option = {
		trigger = {
			has_country_flag = endtimes_cooperator
		}
		name = endtimescrisis.4108.a
	}
	option = {
		trigger = {
			has_country_flag = endtimes_resistance
		}
		name = endtimescrisis.4108.b
	}
}

# Workaround event because idiot cannot the language
#country_event = {
#	id = endtimescrisis.4208
#	hide_window = yes
#	
#	# MOVED TO MONTHLY PULSE
#	
#	trigger = {
#		has_global_flag = endtimes_outsiders_plan
#		NOR = { 
#			has_global_flag = endtimes_instability_I
#			has_global_flag = endtimes_instability_II
#			has_global_flag = endtimes_instability_III
#			
#			has_global_flag = endtimes_monthly_flag
#		}
#		NOT = { any_country = { has_country_flag = endtimes_allow_instability } }
#	}
#	
#	immediate = {
#		every_country = {
#			limit = { is_country_type = global_event }
#			if = {
#				limit = {
#					check_variable = { 
#						which = endtimes_jb_stage_I_var 
#						value <= endtimes_active_jupiter_brains_var
#					}
#				}
#				set_country_flag = endtimes_allow_instability
#			}
#			else = {
#				set_timed_global_flag = { flag = endtimes_monthly_flag months = 1 }
#			}
#		}
#	}
#}

# First Rift Event
country_event = {
	id = endtimescrisis.4009
	hide_window = yes
	fire_only_once = yes
	
	trigger = {
		is_country_type = default
		has_global_flag = endtimes_instability_I
	}
	
	mean_time_to_happen = {
		months = 6
	}
	
	immediate = {
		set_global_flag = endtimes_first_rift
		random_system = {
			limit = { 
				any_planet = { has_planet_flag = endtimes_is_jupiter_brain }
			}
			random_planet = {
				limit = { has_planet_flag = endtimes_is_jupiter_brain }
				
				create_ambient_object = {
					location = this
					type = endtimes_stellar_rift
					
					entity_offset = { min = 10 max = 20 }
					entity_offset_angle = { min = 0 max = 360 }
					entity_offset_height = { min = -5 max = 5 }
				}
				
				save_global_event_target_as = endtimes_rift_01
				set_planet_flag = endtimes_spawned_rift
			}
		}
		
		every_country = {
			limit = { is_country_type = global_event }
			set_variable = { which = "endtimes_rift_count_var" value = 1 }
		}
		
		every_country = {
			limit = { is_country_type = default }
			country_event = { id = endtimescrisis.4109 }
		}
	}
}

country_event = {
	id = endtimescrisis.4109
	title = "endtimescrisis.4109.name"
	desc = "endtimescrisis.4109.desc"
	picture = "GFX_evt_star_pulsar"
	location = event_target:endtimes_rift_01
	
	is_triggered_only = yes
	
	option = {
		trigger = {
			has_country_flag = endtimes_cooperator
		}
		name = endtimescrisis.4109.a
		
		hidden_effect = {
			if = {
				limit = { has_event_chain = crash_the_simulation_chain_coop }
				create_point_of_interest = {
					id = endtimes_stellar_rift.1
					name = "endtimes_stellar_rift_poi" # Can I remove name/desc to make it invisible?
					desc = "endtimes_stellar_rift_poi_desc"
					event_chain = crash_the_simulation_chain_coop
					location = event_target:endtimes_rift_01
				}
				add_event_chain_counter = {
					event_chain = "crash_the_simulation_chain_coop"
					counter = endtimes_simulation_cracks
					amount = 1
				}
			}
		}
	}
	option = {
		trigger = {
			has_country_flag = endtimes_resistance
		}
		name = endtimescrisis.4109.b
		
		hidden_effect = {
			if = {
				limit = { has_event_chain = crash_the_simulation_chain_resist }
				create_point_of_interest = {
					id = endtimes_stellar_rift.1
					name = "endtimes_stellar_rift_poi" # Can I remove name/desc to make it invisible?
					desc = "endtimes_stellar_rift_poi_desc"
					event_chain = crash_the_simulation_chain_resist
					location = event_target:endtimes_rift_01
				}
				add_event_chain_counter = {
					event_chain = "crash_the_simulation_chain_resist"
					counter = endtimes_simulation_cracks
					amount = 1
				}
			}
		}
	}
}

# Instability II Initializer
country_event = {
	id = endtimescrisis.4010
	hide_window = yes
	fire_only_once = yes
	
	trigger = {
		has_global_flag = endtimes_instability_I
		has_global_flag = endtimes_allow_instability
	}
	
	immediate  ={
		set_global_flag = endtimes_instability_II
		remove_global_flag = endtimes_instability_I
		remove_global_flag = endtimes_allow_instability
	}
}

# Second Rift Event
country_event = {
	id = endtimescrisis.4011
	hide_window = yes
	fire_only_once = yes
	
	trigger = {
		is_country_type = default
		has_global_flag = endtimes_instability_II
	}
	
	mean_time_to_happen = {
		months = 6
	}
	
	immediate = {
		random_system = {
			limit = { 
				any_planet = { 
					has_planet_flag = endtimes_is_jupiter_brain
					NOT = { has_planet_flag = endtimes_spawned_rift }
				}
			}
			random_planet = {
				limit = {
					has_planet_flag = endtimes_is_jupiter_brain
					NOT = { has_planet_flag = endtimes_spawned_rift }
				}
				
				create_ambient_object = {
					location = this
					type = endtimes_stellar_rift
					
					entity_offset = { min = 10 max = 20 }
					entity_offset_angle = { min = 0 max = 360 }
					entity_offset_height = { min = -5 max = 5 }
				}
				
				save_global_event_target_as = endtimes_rift_02
				set_planet_flag = endtimes_spawned_rift
			}
		}
		
		every_country = {
			limit = { is_country_type = global_event }
			change_variable = { which = endtimes_rift_count_var value = 1 }
		}
		
		every_country = {
			limit = { is_country_type = default }
			country_event = { id = endtimescrisis.4111 }
		}
	}
}

country_event = {
	id = endtimescrisis.4111
	title = "endtimescrisis.4111.name"
	desc = "endtimescrisis.4111.desc"
	picture = "GFX_evt_star_pulsar"
	location = event_target:endtimes_recent_rift
	
	is_triggered_only = yes
	
	option = {
		trigger = {
			has_country_flag = endtimes_cooperator
		}
		name = endtimescrisis.4111.a
		
		hidden_effect = {
			if = {
				limit = { has_event_chain = crash_the_simulation_chain_coop }
				create_point_of_interest = {
					id = endtimes_stellar_rift.2
					name = "endtimes_stellar_rift_poi" # Can I remove name/desc to make it invisible?
					desc = "endtimes_stellar_rift_poi_desc"
					event_chain = crash_the_simulation_chain_coop
					location = event_target:endtimes_rift_02
				}
				add_event_chain_counter = {
					event_chain = "crash_the_simulation_chain_coop"
					counter = endtimes_simulation_cracks
					amount = 1
				}
			}
		}
	}
	option = {
		trigger = {
			has_country_flag = endtimes_resistance
		}
		name = endtimescrisis.4111.b
		
		hidden_effect = {
			if = {
				limit = { has_event_chain = crash_the_simulation_chain_resist }
				create_point_of_interest = {
					id = endtimes_stellar_rift.2
					name = "endtimes_stellar_rift_poi" # Can I remove name/desc to make it invisible?
					desc = "endtimes_stellar_rift_poi_desc"
					event_chain = crash_the_simulation_chain_resist
					location = event_target:endtimes_rift_02
				}
				add_event_chain_counter = {
					event_chain = "crash_the_simulation_chain_resist"
					counter = endtimes_simulation_cracks
					amount = 1
				}
			}
		}
	}
}

# Instability III Initializer
country_event = {
	id = endtimescrisis.4012
	hide_window = yes
	fire_only_once = yes
	
	trigger = {
		has_global_flag = endtimes_outsiders_plan
		has_global_flag = endtimes_instability_II
		has_global_flag = endtimes_allow_instability
	}
	
	immediate  ={
		set_global_flag = endtimes_instability_III
		remove_global_flag = endtimes_instability_II
		remove_global_flag = endtimes_allow_instability
	}
}

# Third Rift Event
country_event = {
	id = endtimescrisis.4013
	hide_window = yes
	fire_only_once = yes
	
	trigger = {
		is_country_type = default
		has_global_flag = endtimes_instability_III
	}
	
	mean_time_to_happen = {
		months = 6
	}
	
	immediate = {
		random_system = {
			limit = { 
				any_planet = { 
					has_planet_flag = endtimes_is_jupiter_brain
					NOT = { has_planet_flag = endtimes_spawned_rift }
				}
			}
			random_planet = {
				limit = {
					has_planet_flag = endtimes_is_jupiter_brain
					NOT = { has_planet_flag = endtimes_spawned_rift }
				}
				
				create_ambient_object = {
					location = this
					type = endtimes_stellar_rift
					
					entity_offset = { min = 10 max = 20 }
					entity_offset_angle = { min = 0 max = 360 }
					entity_offset_height = { min = 0 max = 0 }
				}
				
				save_global_event_target_as = endtimes_rift_03
				set_planet_flag = endtimes_spawned_rift
			}
		}
		
		every_country = {
			limit = { is_country_type = global_event }
			change_variable = { which = endtimes_rift_count_var value = 1 }
		}
		
		every_country = {
			limit = { is_country_type = default }
			country_event = { id = endtimescrisis.4113 }
		}
	}
}

country_event = {
	id = endtimescrisis.4113
	title = "endtimescrisis.4113.name"
	desc = "endtimescrisis.4113.desc"
	picture = "GFX_evt_star_pulsar"
	location = event_target:endtimes_recent_rift
	
	is_triggered_only = yes
	
	option = {
		trigger = {
			has_country_flag = endtimes_cooperator
		}
		name = endtimescrisis.4113.a
		
		hidden_effect = {
			if = {
				limit = { has_event_chain = crash_the_simulation_chain_coop }
				create_point_of_interest = {
					id = endtimes_stellar_rift.3
					name = "endtimes_stellar_rift_poi" # Can I remove name/desc to make it invisible?
					desc = "endtimes_stellar_rift_poi_desc"
					event_chain = crash_the_simulation_chain_coop
					location = event_target:endtimes_rift_03
				}
				add_event_chain_counter = {
					event_chain = "crash_the_simulation_chain_coop"
					counter = endtimes_simulation_cracks
					amount = 1
				}
			}
		}
	}
	option = {
		trigger = {
			has_country_flag = endtimes_resistance
		}
		name = endtimescrisis.4113.b
		
		hidden_effect = {
			if = {
				limit = { has_event_chain = crash_the_simulation_chain_resist }
				create_point_of_interest = {
					id = endtimes_stellar_rift.3
					name = "endtimes_stellar_rift_poi" # Can I remove name/desc to make it invisible?
					desc = "endtimes_stellar_rift_poi_desc"
					event_chain = crash_the_simulation_chain_resist
					location = event_target:endtimes_rift_03
				}
				add_event_chain_counter = {
					event_chain = "crash_the_simulation_chain_resist"
					counter = endtimes_simulation_cracks
					amount = 1
				}
			}
		}
	}
}

### ESCAPE
country_event = {
	id = endtimescrisis.4014
	hide_window = yes
	fire_only_once = yes
	
	trigger = {
		has_global_flag = endtimes_outsiders_plan
		has_global_flag = endtimes_instability_III
		has_global_flag = endtimes_allow_instability
	}
	
	immediate  ={
		set_global_flag = endtimes_the_escape
		remove_global_flag = endtimes_instability_III
	}
}

# Pulsing Rift Events
country_event = {
	id = endtimescrisis.4015
	hide_window = yes
	
	trigger = {
		is_country_type = default
		has_global_flag = endtimes_the_escape
	}
	
	mean_time_to_happen = {
		months = 4
	}
	
	immediate = {
		random_system = {
			limit = { 
				any_planet = { 
					has_planet_flag = endtimes_is_jupiter_brain
					NOT = { has_planet_flag = endtimes_spawned_rift }
				}
			}
			random_planet = {
				limit = {
					AND = { 
						has_planet_flag = endtimes_is_jupiter_brain
						NOT = { has_planet_flag = endtimes_spawned_rift }
					}
				}
				
				create_ambient_object = {
					location = this
					type = endtimes_stellar_rift
					
					entity_offset = { min = 10 max = 20 }
					entity_offset_angle = { min = 0 max = 360 }
					entity_offset_height = { min = -5 max = 5 }
				}
				
				save_global_event_target_as = endtimes_recent_rift
				set_planet_flag = endtimes_spawned_rift
			}
		}
		
		every_country = {
			limit = { is_country_type = global_event }
			change_variable = { which = endtimes_rift_count_var value = 1 }
		}
		
		every_country = {
			limit = { is_country_type = default }
			country_event = { id = endtimescrisis.4215 }
		}
	}
}

# Beginning of the End
country_event = {
	id = endtimescrisis.4115
	title = "endtimescrisis.4115.name"
	desc = { 
		trigger = { 
			has_country_flag = endtimes_cooperator
		}
		text = endtimescrisis.4115.coop
	}
	desc = { 
		trigger = { 
			has_country_flag = endtimes_resistance
		}
		text = endtimescrisis.4115.resist
	}
	picture = "GFX_evt_star_pulsar"
	location = event_target:endtimes_recent_rift
	
	is_triggered_only = yes
	
	immediate = {
		remove_global_flag = endtimes_outsiders_choice
		remove_global_flag = endtimes_outsiders_plan
	}
	
	option = {
		trigger = {
			has_country_flag = endtimes_cooperator
		}
		name = endtimescrisis.4115.a
		
		hidden_effect = {
			if = {
				limit = { has_event_chain = crash_the_simulation_chain_coop }
				add_event_chain_counter = {
					event_chain = "crash_the_simulation_chain_coop"
					counter = endtimes_simulation_cracks
					amount = 1
				}
			}
		}
	}
	option = {
		trigger = {
			has_country_flag = endtimes_resistance
		}
		name = endtimescrisis.4115.b
		
		hidden_effect = {
			if = {
				limit = { has_event_chain = crash_the_simulation_chain_resist }
				add_event_chain_counter = {
					event_chain = "crash_the_simulation_chain_resist"
					counter = endtimes_simulation_cracks
					amount = 1
				}
			}
			
		}
	}
	
	after = {
		hidden_effect = {
			add_modifier = {
				modifier = endtimes_nihilist_outlook
				days = -1
			}
			set_country_flag = endtimes_beginning_of_the_end
		}
	}
}

# Allocates between named events
country_event = {
	id = endtimescrisis.4215
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		every_country = {
			limit = { NOT = { has_country_flag = endtimes_beginning_of_the_end } }
			country_event = { id = endtimescrisis.4115 }
		}
		every_country = {
			limit = { has_country_flag = endtimes_beginning_of_the_end }
			country_event = { id = endtimescrisis.4415 }
		}
	}
}

# The End Comes Closer
country_event = {
	id = endtimescrisis.4415
	title = "endtimescrisis.4415.name"
	desc = { 
		trigger = { 
			has_country_flag = endtimes_cooperator
		}
		text = endtimescrisis.4415.coop
	}
	desc = { 
		trigger = { 
			has_country_flag = endtimes_resistance
		}
		text = endtimescrisis.4415.resist
	}
	picture = "GFX_evt_star_pulsar"
	location = event_target:endtimes_recent_rift
	
	is_triggered_only = yes
	
	option = {
		trigger = {
			has_country_flag = endtimes_cooperator
		}
		name = endtimescrisis.4415.a
		
		hidden_effect = {
			if = {
				limit = { has_event_chain = crash_the_simulation_chain_coop }
				add_event_chain_counter = {
					event_chain = "crash_the_simulation_chain_coop"
					counter = endtimes_simulation_cracks
					amount = 1
				}
			}
		}
	}
	option = {
		trigger = {
			has_country_flag = endtimes_resistance
		}
		name = endtimescrisis.4415.b
		
		hidden_effect = {
			if = {
				limit = { has_event_chain = crash_the_simulation_chain_resist }
				add_event_chain_counter = {
					event_chain = "crash_the_simulation_chain_resist"
					counter = endtimes_simulation_cracks
					amount = 1
				}
			}
		}
	}
}

# THE END OF DAYS
country_event = {
	id = endtimescrisis.4016
	hide_window = yes
	fire_only_once = yes
	
	trigger = {
		has_global_flag = endtimes_the_escape
		any_country = {
			has_country_flag = endtimes_allow_end_game
		}
	}
	
	immediate = {
		every_country = {
			limit = { is_country_type = default }
			country_event = { id = endtimescrisis.4116 }
		}
		
		every_country = {
			limit = { NOT = { is_country_type = global_event } }
			country_event = { id = endtimescrisis.4416 days = 1 }
		}
	}
}

country_event = {
	id = endtimescrisis.4116
	title = "endtimescrisis.4116.name"
	desc = "endtimescrisis.4116.desc"
	picture = GFX_evt_clocks
	#show_sound = 
	
	is_triggered_only = yes
	
	option = {
		name = endtimescrisis.4116.a
	}
}

country_event = {
	id = endtimescrisis.4416
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		random_planet = {
			limit = { #FIXME
				count_pops = {
					count > 0
				}
			}
			every_pop = {
				kill_pop = yes
			}
		}
		country_event = { id = endtimescrisis.4416 days = 1 }
	}
}

### Resistance Chain
# Courtesy Event to let Resistance empires know that any means must be taken to preserve themselves
country_event = {
	id = endtimescrisis.4017
	hide_window = yes
	fire_only_once = yes
	
	mean_time_to_happen = {
		months = 2
	}
	
	trigger = { 
		has_global_flag = endtimes_first_rift
	}
	
	immediate = {
		every_country = {
			limit = { has_country_flag = endtimes_resistance }
			country_event = { id = endtimescrisis.4117 }
		}
	}
}

# Enables CB?
country_event = {
	id = endtimescrisis.4117
	title = "endtimescrisis.4117.name"
	desc = {
		trigger = {
			OR = {
				has_ethic = ethic_spiritualist
				has_ethic = ethic_fanatic_spiritualist
			}
		}
		text = endtimescrisis.4117.desc.spirit
	}
	desc = {
		trigger = {
			NOR = {
				has_ethic = ethic_spiritualist
				has_ethic = ethic_fanatic_spiritualist
			}
		}
		text = endtimescrisis.4117.desc
	}
	picture = GFX_evt_wormhole # Temp
	show_sound = event_red_alert
	
	is_triggered_only = yes
	
	option = {
		trigger = {
			OR = {
				has_ethic = ethic_spiritualist
				has_ethic = ethic_fanatic_spiritualist
			}
		}
		name = endtimescrisis.4117.a
	}
	option = {
		trigger = {
			NOR = {
				has_ethic = ethic_spiritualist
				has_ethic = ethic_fanatic_spiritualist
			}
		}
		name = endtimescrisis.4117.b
	}
	
	after = {
		
	}
}

## Events Related to destruction of Jupiter Brains
# TODO














































